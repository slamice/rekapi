/**
 * Rekapi - Rewritten Kapi. v0.8.10
 *   By Jeremy Kahn - jeremyckahn@gmail.com
 *   https://github.com/jeremyckahn/rekapi
 *
 * Make fun keyframe animations with JavaScript.
 * Dependencies: Underscore.js (https://github.com/documentcloud/underscore), Shifty.js (https://github.com/jeremyckahn/shifty)
 * MIT Lincense.  This code free to use, modify, distribute and enjoy.
 */
(function(m){var w=function(e,a,c){function j(b,d){return Math.floor(d/b._animationLength)}function h(b){return k()-b._loopTimestamp}function l(b,d){return d>=b._timesToIterate&&-1!==b._timesToIterate}function g(b,d){l(b,d)&&(b.stop(),f(b,"onAnimationComplete"))}function p(b,d,a){return l(b,a)?b._animationLength:d%b._animationLength}function q(b){var d=h(b),a;a=j(b,d);d=p(b,d,a);b.render(d);g(b,a)}function r(b){var d=function(){r(b);q(b)};b._loopId=b._scheduleUpdate.call?b._scheduleUpdate.call(c,
d,1E3/b.config.fps):setTimeout(d,1E3/b.config.fps)}function f(b,a){d.each(b._events[a],function(d){d(b)})}function m(b){return 60!==b?c.setTimeout:c.requestAnimationFrame||c.webkitRequestAnimationFrame||c.oRequestAnimationFrame||c.msRequestAnimationFrame||c.mozCancelRequestAnimationFrame&&c.mozRequestAnimationFrame||c.setTimeout}function o(b){return 60!==b?c.clearTimeout:c.cancelAnimationFrame||c.webkitCancelAnimationFrame||c.oCancelAnimationFrame||c.msCancelAnimationFrame||c.mozCancelRequestAnimationFrame||
c.clearTimeout}function i(b){b._cancelUpdate.call?b._cancelUpdate.call(c,b._loopId):clearTimeout(b._loopId)}var d=a&&a.underscore?a.underscore:e._,k=(a&&a.Tweenable?a.Tweenable:e.Tweenable).util.now,n={fps:60,clearOnUpdate:!0},a=e.Kapi||function(b){this.config=b||{};this.context=this.config.context;this._actors={};this._drawOrder=[];this._playState="stopped";this._drawOrderSorter=null;this._events={onFrameRender:[],onAnimationComplete:[],onPlayStateChange:[],onPlay:[],onPause:[],onStop:[],onBeforeDraw:[]};
this._timesToIterate=-1;this._animationLength=0;this._pausedAtTime=this._loopTimestamp=this._loopId=null;this._lastRenderedMillisecond=0;d.extend(this.config,b);d.defaults(this.config,n);this._scheduleUpdate=m(this.config.fps);this._cancelUpdate=o(this.config.fps);d.each(this._contextInitHook,function(b){b.call(this)},this);return this};a.prototype._contextInitHook={};a.prototype._recalculateAnimationLength=function(){var b=[];d.each(this._actors,function(d){b.push(d.getEnd())});this._animationLength=
Math.max.apply(Math,b);return this};a.prototype.addActor=function(b){if(!d.contains(this._actors,b))b.context()||b.context(this.context),b.kapi=this,b.fps=this.framerate(),this._actors[b.id]=b,this._drawOrder.push(b.id),b.setup();return this};a.prototype.getActor=function(b){return this._actors[b]};a.prototype.getActorIds=function(){return d.pluck(this._actors,"id")};a.prototype.getAllActors=function(){return d.clone(this._actors)};a.prototype.removeActor=function(b){delete this._actors[b.id];delete b.kapi;
this._drawOrder=d.without(this._drawOrder,b.id);b.teardown();this._recalculateAnimationLength();return this};a.prototype.play=function(b){i(this);this._loopTimestamp="paused"===this._playState?this._loopTimestamp+(k()-this._pausedAtTime):k();this._timesToIterate=b||-1;this._playState="playing";r(this);d.each(this._actors,function(b){b._state.isPaused&&b.resume()});f(this,"onPlayStateChange");f(this,"onPlay");return this};a.prototype.playFrom=function(b,d){this.play(d);this._loopTimestamp=k()-b;return this};
a.prototype.playFromCurrent=function(b){return this.playFrom(this._lastRenderedMillisecond,b)};a.prototype.pause=function(){if("paused"===this._playState)return this;this._playState="paused";i(this);this._pausedAtTime=k();d.each(this._actors,function(b){b._state.isTweening&&b.pause()});f(this,"onPlayStateChange");f(this,"onPause");return this};a.prototype.stop=function(){this._playState="stopped";i(this);d.each(this._actors,function(b){b.stop()});f(this,"onPlayStateChange");f(this,"onStop");return this};
a.prototype.isPlaying=function(){return"playing"===this._playState};a.prototype.animationLength=function(){return this._animationLength};a.prototype.lastPositionRendered=function(){return this._lastRenderedMillisecond/this._animationLength};a.prototype.actorCount=function(){return this._drawOrder.length};a.prototype.framerate=function(b){if(b)this.config.fps=b,this._scheduleUpdate=m(this.config.fps),this._cancelUpdate=o(this.config.fps);return this.config.fps};a.prototype.render=function(b){this.calculateActorPositions(b);
var a,k,n,c,g;f(this,"onBeforeDraw");k=this._drawOrder.length;this._drawOrderSorter?(a=d.sortBy(this._actors,this._drawOrderSorter),g=d.pluck(a,"id")):g=this._drawOrder;for(a=0;a<k;a++)n=this._actors[g[a]],c=n.context(),n.render(c,n.get());this._lastRenderedMillisecond=b;f(this,"onFrameRender");return this};a.prototype.redraw=function(){this.render(this._lastRenderedMillisecond);return this};a.prototype.calculateActorPositions=function(b){for(var d=this._drawOrder.length,a=0;a<d;a++)this._actors[this._drawOrder[a]].calculatePosition(b);
return this};a.prototype.moveActorToLayer=function(b,a){if(a<this._drawOrder.length)return this._drawOrder=d.without(this._drawOrder,b.id),this._drawOrder.splice(a,0,b.id),b};a.prototype.bind=function(b,d){if(this._events[b])return this._events[b].push(d),this};a.prototype.unbind=function(b,a){if(this._events[b])return this._events[b]=a?d.without(this._events[b],a):[],this};a.prototype.setOrderFunction=function(b){this._drawOrderSorter=b;return this};a.prototype.unsetOrderFunction=function(){this._drawOrderSorter=
null;return this};a.prototype.exportTimeline=function(){var b={duration:this._animationLength,actorOrder:this._drawOrder.slice(0),actors:{}};d.each(this._drawOrder,function(d){b.actors[d]=this._actors[d].exportTimeline()},this);return b};a.util={};d.extend(a.util,{noop:function(){},calculateLoopPosition:p,calculateTimeSinceStart:h});if("undefined"!==typeof KAPI_DEBUG&&!0===KAPI_DEBUG)a._private={calculateLoopPosition:p,renderCurrentMillisecond:q,tick:r,determineCurrentLoopIteration:j,calculateTimeSinceStart:h,
isAnimationComplete:l,updatePlayState:g};e.Kapi=a},x=function(e,a){function c(d){return d.sort(function(d,a){return d-a})}function j(d,a){for(var n=d._timelinePropertyCacheIndex,b=n.length,c=1;c<b;c++)if(n[c]>=a)return c-1;return-1}function h(d){f.each(d._propertyTracks,function(a,c){d._propertyTracks[c]=f.sortBy(d._propertyTracks[c],function(b){return b.millisecond})})}function l(d){f.each(d._timelinePropertyCaches,function(a,c){var b=g(d,+c);f.defaults(a,b)})}function g(d,a){var c={};f.each(d._propertyTracks,
function(b,d){var g=null;f.find(b,function(b){b.millisecond>a?c[d]=g:b.millisecond===a&&(c[d]=b);g=b;return!!c[d]});if(!c[d]){var e=f.last(b);e&&e.millisecond<=a&&(c[d]=e)}});return c}function p(d){f.each(d._propertyTracks,function(d){f.each(d,function(a,b){a.linkToNext(d[b+1])})})}function q(d,a,c){return f.find(d._propertyTracks[a],function(b){return b.millisecond===c})}var r=0,f=a&&a.underscore?a.underscore:e._,m=a&&a.Tweenable?a.Tweenable:e.Tweenable,o=e.Kapi,i=o.Actor=function(d){d=d||{};this.constructor.call(this);
f.extend(this,{_data:{},_propertyTracks:{},_timelinePropertyCaches:{},_timelinePropertyCacheIndex:[],_keyframeProperties:{},_isPersisting:!1,id:r++,setup:d.setup||o.util.noop,render:d.render||o.util.noop,teardown:d.teardown||o.util.noop});d.context&&this.context(opt_context);return this};ActorMethods=function(){};ActorMethods.prototype=m.prototype;i.prototype=new ActorMethods;i.prototype.context=function(d){if(d)this._context=d;return this._context};i.prototype.keyframe=function(d,a,c){var b,c=c||
"linear";"string"===typeof c&&(b=c,c={},f.each(a,function(d,a){c[a]=b}));f.each(a,function(b,d){c[d]=c[d]||"linear"});f.each(a,function(b,a){var k;k=new o.KeyframeProperty(this,d,a,b,c[a]);this._keyframeProperties[k.id]=k;this._propertyTracks[a]||(this._propertyTracks[a]=[]);this._propertyTracks[a].push(k);h(this)},this);this.kapi._recalculateAnimationLength();this.invalidatePropertyCache();return this};i.prototype.getKeyframeProperty=function(d,a){if(this._propertyTracks[d]&&this._propertyTracks[d][a])return this._propertyTracks[d][a]};
i.prototype.modifyKeyframeProperty=function(d,a,c){this._propertyTracks[d]&&this._propertyTracks[d][a]&&this._propertyTracks[d][a].modifyWith(c);h(this);this.invalidatePropertyCache();return this};i.prototype.getTrackNames=function(){return f.keys(this._propertyTracks)};i.prototype.getTrackLength=function(d){return!this._propertyTracks[d]?void 0:this._propertyTracks[d].length};i.prototype.copyProperties=function(d,a){var c,b;c={};b={};f.each(this._propertyTracks,function(d,g){var f;if(f=q(this,g,
a))c[g]=f.value,b[g]=f.easing},this);this.keyframe(d,c,b);return this};i.prototype.wait=function(d){var a=this.getEnd();if(d<=a)return this;var a=this.getEnd(),c=g(this,this.getEnd()),b={},e={};f.each(c,function(d,a){b[a]=d.value;e[a]=d.easing});this.removeKeyframe(a);this.keyframe(a,b,e);this.keyframe(d,b,e);return this};i.prototype.getStart=function(){var d=[];f.each(this._propertyTracks,function(a){a.length&&d.push(a[0].millisecond)});0===d.length&&(d=[0]);return Math.min.apply(Math,d)};i.prototype.getEnd=
function(){var d=0;f.each(this._propertyTracks,function(a){if(a.length)a=f.last(a).millisecond,a>d&&(d=a)},this);return d};i.prototype.getLength=function(){return this.getEnd()-this.getStart()};i.prototype.modifyKeyframe=function(a,c,g){g=g||{};f.each(this._propertyTracks,function(b,f){var e=q(this,f,a);e&&e.modifyWith({value:c[f],easing:g[f]})},this);return this};i.prototype.removeKeyframe=function(a){f.each(this._propertyTracks,function(c){var g=-1,b=!1;f.find(c,function(c){g++;return b=a===c.millisecond});
b&&(c=c.splice(g,1)[0])&&delete this._keyframeProperties[c.id]},this);this.kapi._recalculateAnimationLength();this.invalidatePropertyCache();return this};i.prototype.removeAllKeyframeProperties=function(){f.each(this._propertyTracks,function(a){a.length=0},this);this._keyframeProperties={};return this.removeKeyframe(0)};i.prototype.moveToLayer=function(a){return this.kapi.moveActorToLayer(this,a)};i.prototype.calculatePosition=function(a){var c=this.getStart(),g=this.getEnd();if(c<=a&&a<=g){var c=
this._timelinePropertyCaches[this._timelinePropertyCacheIndex[j(this,a)]],b={};f.each(c,function(c,g){c&&(b[g]=c.getValueAt(a))});this.set(b)}return this};i.prototype.data=function(a){if(a)this._data=a;return this._data};i.prototype.exportTimeline=function(){var a={start:this.getStart(),end:this.getEnd(),trackNames:this.getTrackNames(),propertyTracks:{}};f.each(this._propertyTracks,function(c,g){var b=a.propertyTracks[g]=[];f.each(c,function(a){b.push(a.exportPropertyData())})});return a};i.prototype.invalidatePropertyCache=
function(){this._timelinePropertyCaches={};f.each(this._keyframeProperties,function(a){this._timelinePropertyCaches[a.millisecond]||(this._timelinePropertyCaches[a.millisecond]={});this._timelinePropertyCaches[a.millisecond][a.name]=a},this);this._timelinePropertyCacheIndex=f.keys(this._timelinePropertyCaches);f.each(this._timelinePropertyCacheIndex,function(a,c){this._timelinePropertyCacheIndex[c]=+a},this);c(this._timelinePropertyCacheIndex);l(this);p(this)}},y=function(e,a){var c=a&&a.underscore?
a.underscore:e._,j=a&&a.Tweenable?a.Tweenable:e.Tweenable,h=e.Kapi.KeyframeProperty=function(a,g,e,j,h){this.id=c.uniqueId("keyframeProperty_");this.ownerActor=a;this.millisecond=g;this.name=e;this.value=j;this.easing=h||"linear";this.nextProperty=null;return this};h.prototype.modifyWith=function(a){var g={};c.each(["millisecond","easing","value"],function(c){g[c]="undefined"===typeof a[c]?this[c]:a[c]},this);c.extend(this,g)};h.prototype.linkToNext=function(a){this.nextProperty=a||null};h.prototype.getValueAt=
function(a){var c,e,h;c={};e={};this.nextProperty?(c[this.name]=this.value,e[this.name]=this.nextProperty.value,h=this.nextProperty.millisecond-this.millisecond,a=(a-this.millisecond)/h,c=j.util.interpolate(c,e,a,this.nextProperty.easing)[this.name]):c=this.value;return c};h.prototype.exportPropertyData=function(){return{id:this.id,millisecond:this.millisecond,name:this.name,value:this.value,easing:this.easing}}},s=function(e,a){function c(a,c,e){"undefined"!==typeof e&&(a[c]=e,a.style[c]=e+"px");
return a[c]}function j(){this.config.clearOnUpdate&&this.canvasClear()}var h=e.Kapi,l=a&&a.underscore?a.underscore:e._;h.prototype._contextInitHook.canvas=function(){this.config.context&&"CANVAS"===this.config.context.nodeName&&(l.each(["Height","Width"],function(a){var c=a.toLowerCase();this.config[c]&&(this["canvas"+a](this.config[c]),delete this.config[a])},this),this.bind("onBeforeDraw",l.bind(j,this)))};h.prototype.canvasHeight=function(a){return c(this.context,"height",a)};h.prototype.canvasWidth=
function(a){return c(this.context,"width",a)};h.prototype.canvasClear=function(){this.canvasContext().clearRect(0,0,this.canvasWidth(),this.canvasHeight());return this};h.prototype.canvasContext=function(){return this.context.getContext("2d")}},t=function(e){function a(){}var c=e.Kapi;a.prototype=c.Actor.prototype;e=c.CanvasActor=function(a){c.Actor.call(this,a);return this};e.prototype=new a;e.prototype.context=function(a){if(a)this._context=a;return this._context&&this._context.getContext("2d")}},
u=function(e,a){function c(){}var j=e.Kapi,h=a&&a.underscore?a.underscore:e._,l=["transform","webkitTransform","MozTransform","oTransform","msTransform"];j.DOMActor=function(a){j.Actor.call(this);this._context=a;a=this.getCSSName();this._context.className.match(a)||(this._context.className+=a);delete this.render;return this};c.prototype=j.Actor.prototype;j.DOMActor.prototype=new c;c.prototype.render=function(a,c){h.each(c,function(c,e){"transform"===e?h.each(l,function(e){a.style[e]=c},this):a.style[e]=
c},this)};c.prototype.getCSSName=function(){return"actor-"+this.id}},v=function(e,a){var c=a?{}:e;w(c,a,e);x(c,a);y(c,a);"function"===typeof u&&u(c,a);"function"===typeof rekapiToCSS&&rekapiToCSS(c,a);"function"===typeof s&&s(c,a);"function"===typeof t&&t(c,a);return c.Kapi};if("function"===typeof define&&define.amd){var z="undefined"!==typeof _;define(["shifty","underscore"],function(e,a){var c={Tweenable:e,underscore:null!==a?a:_},j=v(m,c);if("undefined"!==typeof KAPI_DEBUG&&!0===KAPI_DEBUG)j.underscore_version=
c.underscore.VERSION;z||delete m._;return j})}else v("undefined"!==typeof m?m:this)})(this);
